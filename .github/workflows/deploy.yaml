name: React CI/CD Pipeline
on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:

permissions:
  contents: read


jobs:
  ci:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          # fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # - name: SonarQube Scan
      #   uses: sonarsource/sonarqube-scan-action@v3
      #   env:
      #     SONAR_HOST_URL: https://sonar.indexnine.com
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Install dependencies
        run: npm run test:run

      - name: Build React app
        run: npm run build

      - name: Store build path
        run: |
          echo "BUILD_PATH=$(pwd)/dist" >> $GITHUB_ENV
          echo "âœ… Build available at: $(pwd)/dist"

  cd:
    name: Deploy to Production
    needs: [ci]
    runs-on: self-hosted

    environment:
      name: production
      url: http://localhost:3000

    steps:
      - name: Verify build exists
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory not found!"
            echo "This might happen if the runner cleaned up between jobs."
            exit 1
          fi
          echo "âœ… Build directory found"
          ls -la dist/

      - name: Deploy application
        run: |
          echo "ğŸš€ Starting deployment..."
          DEPLOY_DIR="$HOME/my-app/current"
          mkdir -p "$DEPLOY_DIR"
          echo "ğŸ§¹ Clearing existing deployment..."
          rm -rf "$DEPLOY_DIR"/*
          echo "ğŸ“¦ Copying new build files..."
          cp -r ./dist/* "$DEPLOY_DIR/"
          chmod -R 755 "$DEPLOY_DIR"
          echo "âœ… Files deployed successfully to $DEPLOY_DIR"
          echo "ğŸ“ Deployed files:"
          ls -la "$DEPLOY_DIR"

      - name: Deployment summary
        run: |
          echo "=============================================="
          echo "ğŸ‰ DEPLOYMENT COMPLETE"
          echo "=============================================="
          echo "ğŸ“ Environment: Production"
          echo "ğŸŒ URL: http://localhost:3000"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "=============================================="
